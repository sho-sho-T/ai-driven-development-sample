# 社内図書館管理システム 要件定義書

## 1. 概要

社内の図書館における書籍管理・貸出業務を支援するWebアプリケーション。
複数拠点の図書館をマルチテナントで管理し、利用者間のP2P書籍貸出もサポートする。
DDD・CQRS・モジュラーモノリスの学習を目的としたサンプルアプリケーションでもある。

---

## 2. アクターと役割

| アクター | 説明 |
|---|---|
| **利用者（Member）** | 書籍の検索・閲覧・借用・返却、P2P貸出を行う |
| **図書館管理者（Librarian）** | 書籍・利用者の管理、貸出状況の監視を行う |
| **システム管理者（System Admin）** | 図書館（テナント）の管理、開発用操作を行う |

---

## 3. アプリケーション構成

| アプリ | 対象アクター | 利用端末 | 説明 |
|---|---|---|---|
| **web** | 利用者 | スマホブラウザ | 書籍の借用・返却・P2P貸出・マイページ |
| **admin-web** | 図書館管理者 | PC | 書籍・利用者・管理者の管理 |
| **dev-console** | システム管理者 | PC | 図書館（テナント）管理・開発用操作 |

---

## 4. Bounded Context

| Context | 責務 |
|---|---|
| **catalog** | 書籍情報（ISBNベースのカタログ）と書籍実体（バーコード付き物理書籍）の管理 |
| **lending** | 図書館書籍の貸出・返却、P2P貸出・返却の管理 |
| **member** | 利用者情報の管理（登録・更新） |
| **library** | 図書館（テナント）の管理 |

---

## 5. 機能要件

### 5.1 web（利用者向け）

| ID | 機能 | 説明 |
|---|---|---|
| WEB-1 | 書籍一覧表示 | 図書館の書籍を一覧表示・検索する（タイトル・著者・ISBNで検索可） |
| WEB-2 | 書籍詳細表示 | 書籍の詳細情報（書籍情報・実体）と貸出可否を表示する |
| WEB-3 | 書籍借用 | バーコードスキャンで書籍実体を借りる |
| WEB-4 | 書籍返却 | バーコードスキャンで借用中の書籍を返却する |
| WEB-5 | P2P書籍登録 | 自分の本にバーコードを貼り、ISBNで書籍情報と紐付けてシステムに登録する |
| WEB-6 | P2P貸出 | 自分の本（P2P登録済み）を他の利用者に貸し出す |
| WEB-7 | マイページ | 現在借りている書籍・貸している書籍（P2P）・貸出履歴を確認する |

### 5.2 admin-web（図書館管理者向け）

| ID | 機能 | 説明 |
|---|---|---|
| ADM-1 | 利用者登録 | 名前・メールアドレスを指定して利用者を登録する |
| ADM-2 | 利用者削除 | 利用者を削除する（貸出中は削除不可） |
| ADM-3 | 利用者一覧・検索 | 名前・メールアドレスで利用者を検索・一覧表示する |
| ADM-4 | 利用者貸出状況確認 | 利用者の現在の貸出状況と貸出履歴を確認する |
| ADM-5 | 書籍情報管理 | 書籍情報（ISBN・タイトル・著者・出版社・出版年）の登録・更新・削除 |
| ADM-6 | 書籍実体管理 | バーコード付き書籍実体の登録・削除（書籍情報に紐付け） |
| ADM-7 | 図書館管理者管理 | 図書館管理者の追加・削除 |

### 5.3 dev-console（システム管理者向け）

| ID | 機能 | 説明 |
|---|---|---|
| DEV-1 | 図書館登録 | 新規図書館（テナント）を登録する |
| DEV-2 | 図書館編集 | 図書館の名称・設定情報を編集する |
| DEV-3 | 図書館削除 | 図書館を削除する |
| DEV-4 | DB操作 | 開発時に便利なDB参照・修正操作を行う |

---

## 6. ビジネスルール

### 6.1 書籍ルール

- 書籍情報の ISBN は一意でなければならない
- 書籍情報のタイトルと著者は必須
- 書籍実体は必ず書籍情報（ISBN）と紐付ける
- 書籍実体のバーコードは一意でなければならない
- 貸出中の書籍実体は削除不可

### 6.2 貸出ルール

- 1人の利用者が同時に借りられる書籍は **最大5冊**（図書館書籍 + P2P 合算）
- 貸出期間は **14日間**
- 延長は **1回のみ**、**7日間**
- 延滞中の利用者は新規貸出不可
- 同一書籍実体の重複貸出は不可

### 6.3 P2P書籍ルール

- P2P書籍は利用者が登録し、ISBN で既存の書籍情報と紐付ける
- P2P書籍には固有のバーコードが必要（利用者が貼付する）
- P2P書籍の貸出・返却もバーコードスキャンで行う
- P2P書籍の所有者本人は貸出中であっても自分の本として扱われる

### 6.4 利用者ルール

- メールアドレスは一意でなければならない
- 名前は必須
- 貸出中の書籍がある利用者は削除不可

---

## 7. Context 間の連携

### 7.1 イベントフロー

```
[library]  LibraryRegistered   →  各コンテキストがテナントとして認識
[catalog]  BookRegistered      →  lending が貸出可能な書籍実体として認識
[member]   MemberRegistered    →  lending が貸出可能な利用者として認識
[lending]  BookBorrowed        →  catalog が書籍実体の貸出状態を更新
[lending]  BookReturned        →  catalog が書籍実体の貸出状態を更新
```

### 7.2 Context 間の依存方向

```
lending → catalog  (書籍実体IDで参照)
lending → member   (利用者IDで参照)
lending → library  (図書館IDで参照)
catalog ← lending  (イベント経由で貸出状態同期)
```

---

## 8. 非機能要件

| 項目 | 内容 |
|---|---|
| 認証・認可 | スコープ外（将来対応） |
| マルチテナント | 図書館単位でデータを分離する |
| データベース | Supabase (PostgreSQL) |
| フロントエンド | TanStack Start |
| テスト | Write 側の Domain Model / Application にユニットテスト必須 |
| エラーハンドリング | Result 型による例外レス設計 |

---

## 9. 画面一覧

### web（利用者向け）

| 画面 | パス | 説明 |
|---|---|---|
| 書籍一覧 | `/books` | 書籍の一覧表示・検索 |
| 書籍詳細 | `/books/:id` | 書籍の詳細情報・貸出状態 |
| 書籍借用 | `/borrow` | バーコードスキャンで借用 |
| 書籍返却 | `/return` | バーコードスキャンで返却 |
| P2P書籍登録 | `/my-books/register` | 自分の本をP2Pバーコード登録 |
| マイページ | `/mypage` | 借用中・貸出中（P2P）・履歴 |

### admin-web（図書館管理者向け）

| 画面 | パス | 説明 |
|---|---|---|
| 利用者一覧 | `/members` | 利用者の一覧・検索 |
| 利用者詳細 | `/members/:id` | 利用者詳細・貸出状況 |
| 利用者登録 | `/members/new` | 新規利用者登録 |
| 書籍情報一覧 | `/catalog` | 書籍情報の一覧・検索 |
| 書籍情報登録 | `/catalog/new` | 書籍情報の新規登録 |
| 書籍情報編集 | `/catalog/:id/edit` | 書籍情報の編集 |
| 書籍実体管理 | `/catalog/:id/copies` | バーコード付き書籍実体の管理 |
| 管理者管理 | `/librarians` | 図書館管理者の追加・削除 |

### dev-console（システム管理者向け）

| 画面 | パス | 説明 |
|---|---|---|
| 図書館一覧 | `/libraries` | 図書館の一覧 |
| 図書館登録 | `/libraries/new` | 新規図書館登録 |
| 図書館編集 | `/libraries/:id/edit` | 図書館情報の編集 |
| DB操作 | `/db` | 開発用DB操作 |
